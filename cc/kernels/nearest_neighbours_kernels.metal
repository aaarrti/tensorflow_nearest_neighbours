#include <metal_stdlib>kernel void NearestNeighboursMetalKernel(    // inputs    constant half *token_embeddings [[buffer(0)]],    constant half *embedding_matrix [[buffer(1)]],    // output    device half *outputs [[buffer(2)]],    // attributes    constant int16_t &batch_size [[buffer(3)]],    constant int16_t &sequence_length [[buffer(4)]],    constant int16_t &vocab_size [[buffer(5)]],    constant int16_t &embed_dim [[buffer(6)]],    // thread id    uint2 tid [[thread_position_in_grid]]) {  const int16_t index_in_batch = tid[0];  const int16_t index_in_sequence = tid[1];  thread half dist = 0;  thread int16_t argmin = 0;  thread half new_dist = 0;  for (thread int16_t word_index = 0; word_index != vocab_size; word_index++) {    for (thread int16_t i = 0; i != embed_dim; i++) {      const thread half val1 = embedding_matrix[word_index * vocab_size + i];      const thread half val2 = token_embeddings[index_in_batch * (sequence_length * embed_dim) + index_in_sequence * sequence_length + i];      new_dist += metal::exp2(val1 - val2);    }    new_dist = metal::sqrt(new_dist);    if (new_dist < dist) {      dist = new_dist;      argmin = word_index;    }  }  for (int16_t i = 0; i != embed_dim; i++) {    outputs[index_in_batch * (sequence_length * embed_dim) + index_in_sequence * sequence_length + i] = embedding_matrix[argmin * vocab_size + i];  }}